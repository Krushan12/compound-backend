// Prisma schema for fintech backend
// Path configured via package.json scripts using --schema src/models/schema.prisma

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id         String        @id @default(cuid())
  createdAt  DateTime      @default(now())
  updatedAt  DateTime      @updatedAt
  mobile     String        @unique
  email      String?       @unique
  name       String?
  kycStatus  String        @default("NOT_STARTED")

  kycRecords   KycRecord[]
  subscription Subscription?
  transactions Transaction[]
  publicChatMessages PublicChatMessage[]
}

model KycRecord {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  user      User     @relation(fields: [userId], references: [id])
  userId    String
  provider  String
  status    String
  statusDescription String?
  pan       String?
  name      String?
  isValid   Boolean  @default(false)
  lastChecked   DateTime?
  lastFetched   DateTime?
  lastSubmitted DateTime?
  acknowledgementNumber String?
  rawResponse Json?
}

model Subscription {
  user      User     @relation(fields: [userId], references: [id])
  userId    String   @id
  status    String   @default("INACTIVE")
  plan      String?  // monthly, quarterly, yearly
  amount    Float?   // Amount paid
  startedAt DateTime @default(now())
  expiresAt DateTime?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  tier      String   @default("basic")
}

model Transaction {
  id              String   @id @default(cuid())
  createdAt       DateTime @default(now())
  user            User     @relation(fields: [userId], references: [id])
  userId          String
  provider        String
  providerOrderId String   @unique
  amount          Int
  status          String
}

enum StockStatus {
  entry
  hold
  exit
  exited
}

enum StockPlanTag {
  basic
  advanced
}

model StockRecommendation {
  id           String      @id @default(cuid())
  createdAt    DateTime    @default(now())
  updatedAt    DateTime    @updatedAt
  symbol       String      // NSE trading symbol (e.g., TDPOWERSYS, RELIANCE)
  companyName  String
  dateOfRec    DateTime
  entryZone    String
  averageEntry Float?
  target1      String
  stopLoss     String
  potentialPct Float
  realisedPct  Float?
  status       StockStatus
  planTag      StockPlanTag @default(basic)
  pdfUrl       String?     // Legacy: full URL (deprecated, use pdfKey)
  pdfKey       String?     // S3 key for PDF (e.g., stocks/{id}.pdf)
  currentPrice Float?      // Current market price from NSE
  lastPriceUpdate DateTime? // Last time price was updated
  exitedAt     DateTime?   // Timestamp when stock moved to 'exit' status

  @@index([status, dateOfRec])
}

model MobileOtp {
  id          String   @id @default(cuid())
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  mobile      String   @unique
  code        String
  provider    String
  expiresAt   DateTime?
  attempts    Int      @default(0)
}

model PublicChatMessage {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  user      User?    @relation(fields: [userId], references: [id])
  userId    String?
  text      String
  isAdmin   Boolean  @default(false)

  replyToId String?
  replyTo   PublicChatMessage? @relation("PublicChatMessageReplies", fields: [replyToId], references: [id])
  replies   PublicChatMessage[] @relation("PublicChatMessageReplies")

  @@index([createdAt])
  @@index([replyToId])
}
